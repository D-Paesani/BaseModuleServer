{% extends "layouts/base.html" %}
{% block content %}
<div class="container">
   <div class="card  p-2 my-5">
         <div class="card card-header bg-primary text-center">
               <div class="card-title  ">
                     <h1 class="text-white">PERIPHERALS MANAGER</h1>
               </div>
         </div>
         <div class="card-body">
            <form action = "{{ url_for('cmd.f_peripherals') }}" method = "GET">
               <div class="row">
                  <div class="col-sm-4 text-right">
                     <h3>DU(s) =</h3>
                  </div>
                  <div class="col-sm-3">
                     <input type="text" name="du" class="form-control" value={{prefilldu}} />     
                  </div>
                  <div class="col-sm-4 text-left">
                     (comma or single-space separated)
                  </div>      
               </div>
               <div class="row d-flex justify-content-center mt-4">
                  <input type = "submit" value = "READ" name = "submit" class="btn btn-primary">
               </div>
            </form>
            {% if du %}
               {{ du }}
               {% for ph in du %}
                  <div class="row">
                     <div class="col-sm-4 text-right">
                        <h3>{{ ph }} =</h3>
                     </div>

                     <div class="col-sm-2">
                        {% if du[ph][-1] == 'ON' %}
                           <p><i id="{{ph}}" name="{{ph}}" class="fa fa-solid fa-2x fa-toggle-on fa-beat-fade text-success {{ph}}-toggles" value='1'></i> IS ON</p>
                        {% elif du[ph][-1] == 'OFF' %}
                           <p><i id="{{ph}}" name="{{ph}}" class="fa fa-solid fa-2x fa-toggle-off text-danger {{ph}}-toggles" value='0'></i> IS OFF </p>
                        {% endif %}

                     </div>
                     {% for sw in du[ph][:-1] %}
                        <div class="col-sm-2">
                           {% if sw == '1' %}
                              <p><i class="fa fa-power-off fa-2x fa-beat-fade text-success"></i> {{sw}}</p>
                           {% else %}
                              <p><i class="fa fa-power-off fa-2x fa-beat-fade text-danger"></i> {{sw}}</p>
                           {% endif %}
                        </div>  
                     {% endfor %}      
                  </div>
               {% endfor %}
            {% endif %}
         </div>

         <div class="card-footer text-center">
                Km3NeT - ARCA 2023<br>
                Istituto Nazionale di Fisica Nucleare - Laboratori Nazionali del Sud<br>
                <!-- Source at <a href=https://github.com/D-Paesani/km3net/>D-Paesani/km3net</a><br> -->
         </div>
   </div>
</div>

<script>
   //0 spento
   //1 acceso
   const toggleVeoc = document.querySelectorAll(".veoc-toggles");
   toggleVeoc.forEach((toggleButton) => {
      toggleButton.addEventListener("click", () => {
         const status = toggleButton.getAttribute("value");
         const idp = toggleButton.getAttribute("id");
         const name = toggleButton.getAttribute("name");
         //alert('status attuale '+status);
         const requestBody = {};
         requestBody[name] = [idp, status];
         requestBody['du'] = '{{prefilldu}}'
         fetch('/peripherals', {
            method: 'POST',
            headers: {
               'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
         })
         .then(response => response.json())
         .then(data => {
            console.log(data);
            const resp = JSON.parse(data.response);
            const newstat = JSON.parse(data.status);
            if (resp) {
               //alert('status di ritorno '+newstat);
               if (newstat == 1) {
                  //toggleButton.value = '1';
                  toggleButton.classList.remove("fa-toggle-off");

                  toggleButton.classList.add("fa-toggle-on");
                  
                  
               }
               else {
                  //toggleButton.value = '0';
                  toggleButton.classList.remove("fa-toggle-on");

                  toggleButton.classList.add("fa-toggle-off");
                  

               }
               

            }
            else {
               alert('error');
            }

            location.reload();


      })
   })
   
})
</script>

{% endblock content %}
